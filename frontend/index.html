<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>mrepo - Music Player</title>

    <!-- Runtime configuration -->
    <script src="config.js"></script>

    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0d0d0d;
            color: #e0e0e0;
        }

        /* CSS Custom Properties for dark theme */
        :root {
            /* Primary colors */
            --primary-50: #e3f2fd;
            --primary-100: #bbdefb;
            --primary-200: #90caf9;
            --primary-300: #64b5f6;
            --primary-400: #42a5f5;
            --primary-500: #2196f3;
            --primary-600: #1e88e5;
            --primary-700: #1976d2;

            /* Surface colors (dark) */
            --surface-50: #1a1a1a;
            --surface-100: #242424;
            --surface-200: #2d2d2d;
            --surface-300: #404040;
            --surface-400: #525252;

            /* Text colors */
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;

            /* Status colors */
            --success-100: #1b4332;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;

            --danger-100: #450a0a;
            --danger-500: #ef4444;
            --danger-600: #dc2626;

            /* Input styling */
            --input-bg: #2d2d2d;
            --input-border: #404040;
            --input-text: #e0e0e0;

            /* Shell layout */
            --shell-bg: #0d0d0d;
            --sidebar-bg: #1a1a1a;
            --topbar-bg: #1a1a2e;
            --topbar-text: #e0e0e0;

            /* Card/panel backgrounds */
            --card-bg: #1a1a1a;
            --hover-bg: #2d2d2d;
            --selected-bg: #1e3a5f;
            --border-color: #333;

            /* Toast text colors */
            --text-color: #e0e0e0;
        }

        /* App-specific loading styles */
        .app-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: var(--text-secondary);
        }

        .app-loading-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Hide loading once app loads */
        music-app ~ .app-loading {
            display: none;
        }

        /* Full height app */
        music-app {
            display: block;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading state shown before JS loads -->
    <div class="app-loading">
        <div class="app-loading-icon">ðŸŽµ</div>
        <p>Loading Music Player...</p>
    </div>

    <!-- Main app component -->
    <music-app></music-app>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            // Use updateViaCache: 'none' to ensure sw.js is always fetched fresh
            navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
                .then(reg => {
                    console.log('[App] Service Worker registered:', reg.scope);

                    // Check for updates when user returns to app
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                            reg.update();
                        }
                    });

                    // Listen for updates
                    reg.addEventListener('updatefound', () => {
                        console.log('[App] Service Worker update found');
                    });
                })
                .catch(err => {
                    console.error('[App] Service Worker registration failed:', err);
                });

            // Listen for cache status messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                const { type, status, progress, version, error, previousVersion, updated } = event.data || {};

                if (type === 'cache-status') {
                    // Dispatch custom event for offline-store to handle
                    window.dispatchEvent(new CustomEvent('sw-cache-status', {
                        detail: { status, progress, version, error, updated, previousVersion }
                    }));

                    // Show caching progress in console
                    if (status === 'caching' && progress) {
                        console.log(`[App] Caching: ${progress.current}/${progress.total}`);
                    } else if (status === 'ready') {
                        console.log(`[App] Cache ready (version ${version})`);
                    } else if (status === 'error') {
                        console.error('[App] Cache error:', error);
                    }
                } else if (type === 'update-available') {
                    // New version available - dispatch for offline-store to handle
                    console.log(`[App] Update available: v${previousVersion} â†’ v${version}`);
                    window.dispatchEvent(new CustomEvent('sw-update-available', {
                        detail: { version, previousVersion }
                    }));
                }
            });
        }
    </script>

    <!-- Load the app -->
    <script type="module">
        import './music-app.js';

        // Remove loading state once component is defined
        customElements.whenDefined('music-app').then(() => {
            const loading = document.querySelector('.app-loading');
            if (loading) loading.remove();
        });

        // Set initial hash if none
        if (!window.location.hash) {
            window.location.hash = '/';
        }
    </script>
</body>
</html>
